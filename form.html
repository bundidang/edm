<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Console</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script src="https://cdn.tiny.cloud/1/gdgeef57bszxyna1fpwpbs1q93bvp2cvd4pdezcnjp5n32hk/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>

    <style>
        :root {
            --primary-color: #ff8c00; 
            --secondary-color: #007bff;
            --background-color: #f7f9fc;
            --text-color: #333;
            --border-color: #e0e6ed;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Prompt', sans-serif;
            background-color: var(--background-color);
            margin: 0;
            line-height: 1.6;
        }

        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 40px;
            font-size: 26px;
            font-weight: 700;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo .lite-text {
            font-size: 26px; 
            font-weight: 700; 
            opacity: 1; 
        }

        .main-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .card {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .main-header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px; 
            border-bottom: 2px solid var(--border-color); 
            padding-bottom: 15px;
        }

        h2 {
            font-size: 24px;
            color: var(--text-color);
            padding-bottom: 0px; 
            margin-bottom: 0px; 
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }
        
        .sub-nav {
            list-style: none;
            padding: 0;
            margin: 0 0 20px 0; 
            display: flex;
            border-bottom: 2px solid var(--border-color); 
        }

        .sub-nav li a {
            display: block;
            padding: 10px 20px;
            text-decoration: none;
            color: #666;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px; 
        }

        .sub-nav li a:hover {
            color: var(--primary-color);
        }

        .sub-nav li a.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }
        
        .tab-pane {
            display: none;
        }
        .tab-pane.active {
            display: block;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-col {
            flex: 1; 
            min-width: 0; 
        }
        
        #confirmation-email ul {
            list-style: none; 
            padding: 0;
        }
        #confirmation-email ul li {
            padding: 5px 0;
            display: flex;
            align-items: center;
        }
        #confirmation-email ul li input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.1);
        }
        #confirmation-email ul li label {
            font-weight: 400;
            margin-bottom: 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .input-text {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box;
            font-family: 'Prompt', sans-serif;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end; 
            gap: 15px; 
            margin-top: 0px; 
            flex-shrink: 0;
        }

        .btn-submit {
            background-color: #007bff;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-submit:hover {
            background-color: #0056b3;
        }

        .btn-back {
            background-color: #6c757d;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tox-tinymce {
            border-radius: 6px !important;
        }
        
        .card-header {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        input.datepicker-input {
            background-color: #fff;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 35px; 
            cursor: pointer;
        }
        
        #start-time, #end-time {
            background-image: none;
            padding-right: 10px; 
            cursor: text;
        }

        .ui-datepicker {
            font-family: 'Prompt', sans-serif !important;
            font-size: 14px !important;
        }
        
        #name-list-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        #name-list-table th, #name-list-table td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: left;
            font-size: 14px;
        }
        #name-list-table th {
            background-color: #f0f4f7;
            color: var(--text-color);
            font-weight: 600;
        }
        #name-list-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .name-list-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }
        
        #name-list-table th {
            text-align: center;
        }
        
        #name-list-table td:nth-child(1),
        #name-list-table td:nth-child(2),
        #name-list-table td:nth-child(5),
        #name-list-table td:nth-child(7),
        #name-list-table td:nth-child(8) {
            text-align: center;
        }
        
        #name-list-table th:nth-child(3),
        #name-list-table th:nth-child(4),
        #name-list-table th:nth-child(6) {
            text-align: left;
        }
        
        #name-list-table td span[contenteditable="true"] {
             border-bottom: 1px dashed #007bff;
             cursor: text;
             display: block;
             padding: 0 5px;
             margin: -5px;
             min-height: 14px;
        }
        
        #name-list-table td span[contenteditable="true"]:focus {
             background-color: #ffffdd;
             outline: none;
        }

        .toggle-switch {
            display: inline-block;
            height: 34px;
            position: relative;
            width: 60px;
        }

        .toggle-switch input {
            display: none;
        }

        .slider {
            background-color: #ccc;
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            background-color: white;
            bottom: 4px;
            content: "";
            height: 26px;
            left: 4px;
            position: absolute;
            transition: .4s;
            width: 26px;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #28a745;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .email-status {
            font-size: 14px;
            font-weight: 600;
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            display: block;
        }

        .status-on {
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
        }

        .status-off {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
        }
        
        .status-dot {
            height: 12px;
            width: 12px;
            border-radius: 50%;
            display: inline-block;
            vertical-align: middle;
            margin: 0 auto;
        }
        .status-dot.sent {
            background-color: #28a745;
        }
        .status-dot.not-sent {
            background-color: #dc3545;
        }
        .status-dot.waiting {
            background-color: #6c757d;
        }
        .delivery-icon {
            font-size: 18px;
            display: block;
            text-align: center;
        }
        .delivery-icon.delivered {
            color: #28a745;
        }
        .delivery-icon.pending {
            color: #dc3545;
        }
        .delivery-icon.waiting {
            color: #6c757d;
        }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Load Data */
        .btn-load-data {
            background-color: #17a2b8;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }
        .btn-load-data:hover {
            background-color: #138496;
        }
        .input-loading {
            border-color: #ffc107;
            background-color: #fff3cd;
        }
    </style>
</head>
<body>
    <script>
        // üí° ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ
        if (sessionStorage.getItem('isLoggedIn') !== 'true') {
            window.location.href = 'index.html'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login
        }

        function handleLogout() {
            if (confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                sessionStorage.removeItem('isLoggedIn');
                sessionStorage.removeItem('username');
                sessionStorage.removeItem('role');
                window.location.href = 'index.html'; // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Login
            }
        }
    </script>
    <header class="header">
        <div class="logo" onclick="confirmBeforeExit('main.html')" style="cursor: pointer;">Email <span class="lite-text">Console</span></div>
        <div style="display: flex; gap: 10px;">
            <button type="button" onclick="confirmBeforeExit('main.html')" style="padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; background-color: #e95900; color: white;">
                <i class="fas fa-arrow-left" style="margin-right: 5px;"></i> Back to Dashboard
            </button>
            <button type="button" onclick="handleLogout()" style="padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; background-color: #dc3545; color: white;">
                <i class="fas fa-sign-out-alt" style="margin-right: 5px;"></i> Logout
            </button>
        </div>
    </header>

    <div class="main-container">
        <form id="edm-form">
            
            <div class="main-header-actions">
                <h2><i class="fas fa-envelope-open-text" style="margin-right: 10px;"></i> Email Console Setup</h2>
                <div class="form-actions">
                    <button type="button" class="btn-back" onclick="confirmBeforeExit('main.html')"><i class="fas fa-times-circle"></i> Cancel</button>
                    <button type="submit" class="btn-submit">
                        <i class="fas fa-save"></i> Save All Settings
                    </button>
                </div>
            </div>
            
            <ul class="sub-nav">
                <li><a href="#" class="active" onclick="showTab('edm-invitation', this)">EDM Invitation</a></li>
                <li><a href="#" onclick="showTab('name-list', this)">Name List</a></li> 
                <li><a href="#" onclick="showTab('confirmation-email', this)">Confirmation Email</a></li>
            </ul>

            <div id="tab-content">
                <div id="edm-invitation" class="tab-pane active">
                    <div class="card">
                        <div class="card-header">Event Detail</div>
                        <div class="form-group">
                            <label for="event-title">Event Title</label>
                            <input type="text" id="event-title" class="input-text" required>
                        </div>
                        <div class="form-group">
                            <label for="event-venue">Venue</label>
                            <input type="text" id="event-venue" class="input-text">
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">Event Date & Time</div>
                        <div class="form-group">
                            <div class="form-row">
                                <div class="form-col">
                                    <label for="start-date">Start Date</label>
                                    <input type="text" id="start-date" class="input-text datepicker-input" placeholder="dd/mm/yyyy" required>
                                </div>
                                <div class="form-col">
                                    <label for="end-date">End Date</label>
                                    <input type="text" id="end-date" class="input-text datepicker-input" placeholder="dd/mm/yyyy" required>
                                </div>
                                <div class="form-col">
                                    <label for="start-time">Start Time</label>
                                    <input type="text" id="start-time" class="input-text time-input-mask" placeholder="HH:MM">
                                </div>
                                <div class="form-col">
                                    <label for="end-time">End Time</label>
                                    <input type="text" id="end-time" class="input-text time-input-mask" placeholder="HH:MM">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">Email Subject Line (Invitation)</div>
                        <div class="form-group">
                            <label for="email-subject">Email Subject Line</label>
                            <input type="text" id="email-subject" class="input-text" required>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">EDM Content</div>
                        <div class="form-group">
                            <label for="edm-content">EDM / Invitation Content (Supports HTML, Images, Tables)</label>
                            <textarea id="edm-content"></textarea>
                        </div>
                    </div>
                </div> 
                
                <div id="name-list" class="tab-pane">
                    <div class="card">
                        <div class="card-header" style="color: var(--secondary-color);">
                            <i class="fas fa-cloud-download-alt" style="margin-right: 5px;"></i> Load Name List from Google Sheet
                        </div>
                        <div class="form-group">
                            <label for="sheet-url">Google Sheet URL</label>
                            <input type="url" id="sheet-url" class="input-text" placeholder="https://docs.google.com/spreadsheets/d/..." required>
                        </div>
                        <div class="form-group">
                            <label for="sheet-name">Sheet Name (e.g., 'Sheet1')</label>
                            <input type="text" id="sheet-name" class="input-text" value="NameList" required>
                        </div>
                        <button type="button" class="btn-load-data" onclick="loadNameListFromSheet()">
                            <i class="fas fa-sync-alt"></i> Load Data from Sheet
                        </button>
                    </div>

                    <div id="name-list-display" style="display: none; margin-top: 20px;">
                        <div class="card-header" style="color: var(--secondary-color); border-bottom: none; padding-bottom: 0;">
                            <i class="fas fa-list-ul" style="margin-right: 5px;"></i>
                            Target List (Selected: <span id="selected-count">0</span> / <span id="total-count">0</span>)
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <div style="display: flex; gap: 10px;">
                                <button type="button" class="btn-submit" style="background-color: #337ab7;" onclick="toggleEditMode()">
                                    <i class="fas fa-edit"></i> <span id="edit-button-text">Edit List</span>
                                </button>
                                <button type="button" class="btn-submit" style="background-color: #dc3545;" onclick="clearNameListData()">
                                    <i class="fas fa-trash-alt"></i> Clear Data
                                </button>
                                <button type="button" class="btn-submit" style="background-color: #17a2b8;" onclick="exportToXLSX()">
                                    <i class="fas fa-file-excel"></i> Export
                                </button>
                            </div>
                            <button type="button" class="btn-submit" style="background-color: #28a745;" onclick="sendNameListEmail()">
                                <i class="fas fa-paper-plane"></i> Send EDM Invitation
                            </button>
                        </div>
                        <div class="name-list-container">
                            <table id="name-list-table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="select-all-checkbox" onclick="toggleSelectAll()"></th>
                                        <th>#</th>
                                        <th>Name</th>
                                        <th>Company</th>
                                        <th>Phone</th>
                                        <th>Email</th>
                                        <th style="width: 80px; text-align: center;">EDM Sent</th>
                                        <th style="width: 100px; text-align: center;">Delivery Status</th>
                                    </tr>
                                </thead>
                                <tbody id="name-list-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="confirmation-email" class="tab-pane">
                    <div class="card">
                        <div class="card-header">Confirmation Email Subject</div>
                        <div class="form-group">
                            <label for="confirm-subject">Email Subject</label>
                            <input type="text" id="confirm-subject" class="input-text"
                                   value="Thank you for your online registration of : [Event Title]" required>
                        </div>
                    </div>
                    <div class="form-row" style="align-items: flex-start;">
                        <div class="form-col" style="max-width: 350px;">
                            <div class="card">
                                <div class="card-header" style="color: #007bff;">Automatic Email Settings</div>
                                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                    <label for="toggle-auto-send" style="font-weight: 700; color: #333; margin-bottom: 0;">
                                        Enable Auto Confirmation Email
                                    </label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="toggle-auto-send">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <p style="color: red; font-size: 14px; font-weight: 600; margin-top: 0; padding-top: 0;">
                                    Automatic Send Confirmation Email (*Require email in registration form)
                                </p>
                                <div id="email-polling-status" class="email-status status-off">
                                    Auto-Send: **REQUIRES BACKEND**. Status depends on Google Apps Script Web App.
                                </div>
                                
                                <div class="card-header" style="color: var(--primary-color);">Content Toggles</div>
                                <div class="form-group">
                                    <label style="font-weight: 700; color: var(--primary-color);">Email Content Elements</label>
                                    <ul style="list-style: none; padding: 0;">
                                        <li><input type="checkbox" id="toggle-success" checked> <label for="toggle-success">Show Registration Success</label></li>
                                        <li><input type="checkbox" id="toggle-welcome" checked> <label for="toggle-welcome">Show Welcome</label></li>
                                        <li><input type="checkbox" id="toggle-date" checked> <label for="toggle-date">Show event date</label></li>
                                        <li><input type="checkbox" id="toggle-venue" checked> <label for="toggle-venue">Show venue</label></li>
                                        <li><input type="checkbox" id="toggle-qrcode" checked> <label for="toggle-qrcode">Show QR Code</label></li>
                                        <li><input type="checkbox" id="toggle-ref" checked> <label for="toggle-ref">Show Your reference ID</label></li>
                                        <li><input type="checkbox" id="toggle-fullname"> <label for="toggle-fullname">Show full name</label></li>
                                    </ul>
                                </div>
                                <button type="button" class="btn-submit" onclick="updatePreview()" style="background-color: #007bff;">
                                    <i class="fas fa-eye"></i> PREVIEW EMAIL
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-col">
                            <div class="card" style="min-height: 400px; border: 1px solid #ccc; background-color: #efefef;">
                                <div class="card-header" style="border-bottom: none; color: #333;">Live Preview</div>
                                <div id="email-preview" style="background-color: white; padding: 20px; text-align: center; border-radius: 8px; font-family: 'Prompt', sans-serif;">
                                    <p style="color: #28a745; font-weight: 700; font-size: 24px; margin-bottom: 5px;">Registration Success !</p>
                                    <p style="margin-top: 5px;">
                                        Welcome, you are registered
                                        <br>
                                        <strong style="color: #333; font-size: 20px;">[Event Title Placeholder]</strong>
                                    </p>
                                    <p style="font-size: 14px; margin: 5px 0;">dd/mm/yyyy - dd/mm/yyyy | 00:00 - 00:00</p>
                                    <p style="font-size: 14px; margin: 5px 0;"><strong style="font-size: 14px;">[Venue Placeholder]</strong></p>
                                    <div style="margin: 15px auto;">
                                        <img src="https://chart.googleapis.com/chart?cht=qr&chs=150x150&chl=EF7FYP" alt="QR Code Placeholder" style="width: 150px; height: 150px;">
                                    </div>
                                    <p style="font-size: 14px; margin: 5px 0;">Your reference ID: <strong style="color: red;">EF7FYP (Placeholder)</strong></p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </form>
    </div>

    <script>
        // üí°üí°üí° IMPORTANT: PUT YOUR BACKEND/APPS SCRIPT API URL HERE üí°üí°üí°
        // URL ‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ API Endpoint ‡∏Ç‡∏≠‡∏á Backend ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á SMTP ‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Google Sheet
        const BACKEND_API_URL = 'https://your-backend-or-gas-endpoint.com/api'; 
        
        // üí° URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Google Sheet (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Web App ‡∏ó‡∏µ‡πà‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡πÅ‡∏•‡πâ‡∏ß)
        const SHEET_API_URL = 'https://script.google.com/macros/s/YOUR_APPS_SCRIPT_DEPLOYMENT_ID/exec'; // <--- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

        let isDirty = false;
        let nameListData = []; 
        let isEditMode = false;
        
        $(function() {
            $(".datepicker-input").datepicker({
                dateFormat: 'dd/mm/yy', 
                showOn: "focus",
                changeMonth: true,
                changeYear: true
            });
            
            $(".time-input-mask").mask('00:00'); 
            
            $("#start-date, #end-date, #start-time, #end-time").on('change input', updatePreview);
            $("#event-title, #event-venue, #confirm-subject").on('input', updatePreview); 
        });
        
        function formatDisplayDate(dateStr) {
            if (!dateStr) return "dd/mm/yyyy";
            return dateStr; 
        }

        tinymce.init({
            selector: '#edm-content',
            height: 500,
            plugins: [
                'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
                'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                'insertdatetime', 'media', 'table', 'wordcount', 'nonbreaking',
                'emoticons', 'help', 'fullpage', 'visualchars' 
            ],
            toolbar: 'undo redo | formatselect | fontsizeselect |' +
                     'bold italic underline strikethrough forecolor backcolor | alignleft aligncenter alignright alignjustify |' +
                     'bullist numlist outdent indent | link image media table | hr charmap emoticons |' +
                     'fullpage code visualblocks fullscreen preview help',
            menubar: 'file edit view insert format tools table help',
            content_style: 'body { font-family:"Prompt",sans-serif; font-size:16px }',
            fullpage_default_doctype: '<!DOCTYPE html>',
            fullpage_default_encoding: 'UTF-8',
            media_url_resolver: function (data, resolve) {
                if (data.url.indexOf('youtube') !== -1 || data.url.indexOf('vimeo') !== -1) {
                    resolve({html: `<iframe src="${data.url}" width="100%" height="400" frameborder="0" allowfullscreen></iframe>`});
                    return;
                }
                resolve({html: ''});
            }
        });
        
        function showTab(tabId, element) {
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.sub-nav a').forEach(link => {
                link.classList.remove('active');
            });
            if (element) {
                element.classList.add('active');
            }
            
            if (tabId === 'confirmation-email') {
                updatePreview();
            }
            
            if (tabId === 'name-list') {
                 if (nameListData.length > 0) {
                     document.getElementById('name-list-display').style.display = 'block';
                     renderNameList();
                 }
                 if (isEditMode) {
                    saveNameListEdit();
                 }
            }
        }

        function updatePreview() {
            const previewDiv = document.getElementById('email-preview');
            
            const startDate = formatDisplayDate(document.getElementById('start-date').value); 
            const endDate = formatDisplayDate(document.getElementById('end-date').value);
            const rawStartTime = document.getElementById('start-time').value;
            const rawEndTime = document.getElementById('end-time').value;
            const startTime = rawStartTime || "00:00"; 
            const endTime = rawEndTime || "00:00";
            
            const eventTitle = document.getElementById('event-title').value || "Event Title Placeholder";
            const eventVenue = document.getElementById('event-venue').value || "Venue Placeholder";
            
            const showSuccess = document.getElementById('toggle-success').checked;
            const showWelcome = document.getElementById('toggle-welcome').checked;
            const showDate = document.getElementById('toggle-date').checked;
            const showVenue = document.getElementById('toggle-venue').checked;
            const showQR = document.getElementById('toggle-qrcode').checked;
            const showRef = document.getElementById('toggle-ref').checked;
            const showFullName = document.getElementById('toggle-fullname').checked; 
            
            const defaultSubjectPrefix = "Thank you for your online registration of : ";
            const confirmSubjectInput = document.getElementById('confirm-subject');
            
            if (confirmSubjectInput) {
                const newTitleForSubject = document.getElementById('event-title').value.trim() || "[Event Title]"; 
                const newSubject = defaultSubjectPrefix + newTitleForSubject;
                const currentValue = confirmSubjectInput.value.trim();
                const usesDefaultStructure = currentValue.startsWith(defaultSubjectPrefix);
                const isPlaceholderOrEmpty = (currentValue === defaultSubjectPrefix + '[Event Title]' || currentValue === '');
                
                if (usesDefaultStructure || isPlaceholderOrEmpty) {
                    confirmSubjectInput.value = newSubject;
                }
            }

            let html = '';
            
            if (showSuccess) {
                html += `<p style="color: #28a745; font-weight: 700; font-size: 24px; margin-bottom: 5px;">Registration Success !</p>`;
            }
            
            if (showWelcome) {
                 html += `<p style="margin-top: 5px;">
                            Welcome, you are registered
                            <br>
                            <strong style="color: #333; font-size: 20px;">${eventTitle}</strong>
                          </p>`;
            }
            
            if (showFullName) {
                html += `<p style="font-size: 16px; margin: 10px 0;">Registered Full Name: <strong style="color: #007bff;">[Full Name Placeholder]</strong></p>`;
            }

            if (showDate) {
                html += `<p style="font-size: 14px; margin: 5px 0;">${startDate}${startDate !== endDate ? ' - ' + endDate : ''} | ${startTime} - ${endTime}</p>`;
            }

            if (showVenue) {
                html += `<p style="font-size: 14px; margin: 5px 0;"><strong style="font-size: 14px;">${eventVenue}</strong></p>`;
            }

            if (showQR) {
                 html += `<div style="margin: 15px auto;">
                            <img src="https://chart.googleapis.com/chart?cht=qr&chs=150x150&chl=EF7FYP" alt="QR Code" style="width: 150px; height: 150px;">
                         </div>`;
            }
            
            if (showRef) {
                html += `<p style="font-size: 14px; margin: 5px 0;">Your reference ID: <strong style="color: red;">EF7FYP (Placeholder)</strong></p>`;
            }
            
            if (html === '') {
                 html = `<p style="color: #6c757d; font-style: italic;">No content elements are currently selected for the email. Please check the toggles.</p>`;
            }

            previewDiv.innerHTML = html;
        }

        function isFormDirty() {
            return isDirty;
        }

        function confirmBeforeExit(targetUrl) {
            if (isFormDirty()) {
                const confirmation = confirm("‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å! ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏•‡∏∞‡∏ó‡∏¥‡πâ‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?");
                if (confirmation) {
                    isDirty = false;
                    window.location.href = targetUrl;
                }
            } else {
                window.location.href = targetUrl;
            }
        }

        function getConfirmationToggles() {
            return {
                showSuccess: document.getElementById('toggle-success').checked,
                showWelcome: document.getElementById('toggle-welcome').checked,
                showDate: document.getElementById('toggle-date').checked,
                showVenue: document.getElementById('toggle-venue').checked,
                showQR: document.getElementById('toggle-qrcode').checked,
                showRef: document.getElementById('toggle-ref').checked,
                showFullName: document.getElementById('toggle-fullname').checked,
                autoSend: document.getElementById('toggle-auto-send').checked 
            };
        }
        
        function setConfirmationToggles(toggles) {
            document.getElementById('toggle-success').checked = toggles.showSuccess ?? true;
            document.getElementById('toggle-welcome').checked = toggles.showWelcome ?? true;
            document.getElementById('toggle-date').checked = toggles.showDate ?? true;
            document.getElementById('toggle-venue').checked = toggles.showVenue ?? true;
            document.getElementById('toggle-qrcode').checked = toggles.showQR ?? true;
            document.getElementById('toggle-ref').checked = toggles.showRef ?? true;
            document.getElementById('toggle-fullname').checked = toggles.showFullName ?? false; 
            document.getElementById('toggle-auto-send').checked = toggles.autoSend ?? false;
        }
        
        function getQueryParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        document.addEventListener('DOMContentLoaded', () => {
            showTab('edm-invitation', document.querySelector('.sub-nav a'));
            
            document.querySelectorAll('input, select, textarea').forEach(element => {
                if (element.id !== 'edm-content' && element.id !== 'sheet-url' && element.id !== 'sheet-name') {
                     element.addEventListener('input', () => { isDirty = true; });
                     element.addEventListener('change', () => { isDirty = true; });
                }
            });
            // üí° ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö URL ‡πÅ‡∏•‡∏∞ Sheet Name ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏ô localStorage ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ isDirty
            document.getElementById('sheet-url').addEventListener('input', (e) => {
                isDirty = true;
                localStorage.setItem('sheetUrl', e.target.value);
            });
            document.getElementById('sheet-name').addEventListener('input', (e) => {
                isDirty = true;
                localStorage.setItem('sheetName', e.target.value);
            });
            
            // üí° ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤ URL ‡πÅ‡∏•‡∏∞ Sheet Name ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
            document.getElementById('sheet-url').value = localStorage.getItem('sheetUrl') || '';
            document.getElementById('sheet-name').value = localStorage.getItem('sheetName') || 'NameList';


            setTimeout(() => {
                const editor = tinymce.get('edm-content');
                if (editor) {
                    editor.on('change', () => { isDirty = true; });
                }
            }, 1000); 

            document.querySelectorAll('#confirmation-email input[type="checkbox"]').forEach(checkbox => {
                if (checkbox.id !== 'toggle-auto-send') { 
                    checkbox.addEventListener('change', updatePreview);
                    checkbox.addEventListener('change', () => { isDirty = true; }); 
                } else {
                     checkbox.addEventListener('change', () => { isDirty = true; }); 
                }
            });

            document.querySelectorAll('#edm-invitation input[type="text"]').forEach(input => {
                input.addEventListener('input', updatePreview);
            });
            document.getElementById('confirm-subject').addEventListener('input', updatePreview);
            
            const eventId = getQueryParameter('id');
            if (eventId) {
                document.querySelector('.btn-submit').innerHTML = '<i class="fas fa-save"></i> Update';
                
                const events = JSON.parse(localStorage.getItem('events')) || [];
                const eventToEdit = events.find(event => event.id === eventId) || {};

                if (eventToEdit.id) {
                    document.getElementById('event-title').value = eventToEdit.title || '';
                    document.getElementById('email-subject').value = eventToEdit.subject || '';
                    document.getElementById('event-venue').value = eventToEdit.venue || '';
                    document.getElementById('start-date').value = eventToEdit.startDate || ''; 
                    document.getElementById('end-date').value = eventToEdit.endDate || '';     
                    document.getElementById('start-time').value = eventToEdit.startTime || '';
                    document.getElementById('end-time').value = eventToEdit.endTime || '';
                    
                    setTimeout(() => {
                         tinymce.get('edm-content').setContent(eventToEdit.content || '');
                    }, 500); 
                    
                    document.getElementById('confirm-subject').value =
                        eventToEdit.confirmSubject || `Thank you for your online registration of : ${eventToEdit.title || '[Event Title]'}`;
                    
                    if (eventToEdit.toggles) {
                        setConfirmationToggles(eventToEdit.toggles);
                    }

                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.id = 'edit-event-id';
                    hiddenInput.value = eventId; 
                    document.getElementById('edm-form').appendChild(hiddenInput);
                    
                    updatePreview();
                } else {
                    alert('Could not find the Event to edit.');
                }
            } else {
                updatePreview(); 
            }
            
            loadNameListFromStorage();
            toggleEmailSending();
            document.getElementById('toggle-auto-send').addEventListener('change', toggleEmailSending);
        });

        document.getElementById('edm-form').addEventListener('submit', function(event) {
            event.preventDefault();
            
            if (tinymce.get('edm-content') === null) {
                alert('Please wait for the editor to load.');
                return;
            }
            
            if (isEditMode) {
                saveNameListEdit();
            }

            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const startTime = document.getElementById('start-time').value; 
            const endTime = document.getElementById('end-time').value;   

            const eventTitle = document.getElementById('event-title').value;
            const emailSubject = document.getElementById('email-subject').value;
            const eventVenue = document.getElementById('event-venue').value; 
            const content = tinymce.get('edm-content').getContent();
            const confirmSubject = document.getElementById('confirm-subject').value; 
            const toggles = getConfirmationToggles(); 

            const editEventId = document.getElementById('edit-event-id') ? document.getElementById('edit-event-id').value : null;

            let events = JSON.parse(localStorage.getItem('events')) || [];
            
            const dateFullStr = `${startDate}${startDate !== endDate ? ' - ' + endDate : ''}`;

            if (editEventId) {
                const eventIndex = events.findIndex(e => e.id === editEventId);
                if (eventIndex > -1) {
                    events[eventIndex] = {
                        ...events[eventIndex], 
                        title: eventTitle,
                        subject: emailSubject,
                        venue: eventVenue, 
                        startDate: startDate, 
                        endDate: endDate,     
                        startTime: startTime, 
                        endTime: endTime,     
                        date_full: dateFullStr,     
                        content: content, 
                        confirmSubject: confirmSubject, 
                        toggles: toggles, 
                    };
                    alert(`‚úÖ Settings Updated Successfully!\n\nEvent Title: ${eventTitle}`);
                }
            } else {
                const newEvent = {
                    id: 'event-' + Date.now(),
                    title: eventTitle,
                    subject: emailSubject,
                    createDate: new Date().toISOString(), 
                    venue: eventVenue, 
                    startDate: startDate, 
                    endDate: endDate,     
                    startTime: startTime, 
                    endTime: endTime,     
                    content: content,
                    date_full: dateFullStr, 
                    confirmSubject: confirmSubject,
                    toggles: toggles, 
                };

                events.unshift(newEvent);
                alert(`‚úÖ Settings Saved Successfully!\n\nEvent Title: ${eventTitle}`);
            }

            localStorage.setItem('events', JSON.stringify(events));
            isDirty = false; 
            
            if (editEventId) {
                 document.querySelector('.btn-submit').innerHTML = '<i class="fas fa-save"></i> Update';
            } else {
                 document.querySelector('.btn-submit').innerHTML = '<i class="fas fa-save"></i> Save All Settings';
            }
            
            saveNameListToStorage();
        });
        
        // ===================== NAME LIST: GOOGLE SHEET =====================

        function processNameListData(rows) {
            nameListData = rows
                .filter(item => item.Name || item.Email)
                .map((item, index) => ({
                    id: item.No || index + 1,
                    name: item.Name || '-',
                    company: item.Company || '-',
                    phone: item.Phone || item.Telephone || '-',
                    email: item.Email || item['E-Mail'] || '-',
                    checked: true,
                    // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å Storage ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                    sendStatus: item.sendStatus || 'waiting', 
                    deliveryStatus: item.deliveryStatus || 'waiting'
                }));
            
            if (nameListData.length > 0) {
                renderNameList();
                saveNameListToStorage(); 
            } else {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô Google Sheet (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Name ‡πÅ‡∏•‡∏∞ Email/E-Mail ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà)');
                document.getElementById('name-list-display').style.display = 'none';
            }
        }

        async function loadNameListFromSheet() {
            const sheetUrl = document.getElementById('sheet-url').value.trim();
            const sheetName = document.getElementById('sheet-name').value.trim();
            const loadButton = document.querySelector('.btn-load-data');
            
            if (!sheetUrl || !sheetName) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Google Sheet URL ‡πÅ‡∏•‡∏∞ Sheet Name ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }
            
            const sheetIdMatch = sheetUrl.match(/\/d\/(.+?)\/edit/);
            const sheetId = sheetIdMatch ? sheetIdMatch[1] : null;

            if (!sheetId) {
                alert('URL ‡∏Ç‡∏≠‡∏á Google Sheet ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }
            
            loadButton.disabled = true;
            loadButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Loading...`;
            document.getElementById('sheet-url').classList.add('input-loading');
            document.getElementById('sheet-name').classList.add('input-loading');

            // üí° 1. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Google Apps Script Web App ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const url = `${SHEET_API_URL}?sheetId=${sheetId}&sheetName=${encodeURIComponent(sheetName)}`;
            
            try {
                const response = await fetch(url, { method: 'GET', mode: 'cors' });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // üí° 2. ‡∏ú‡∏ô‡∏ß‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡∏Å‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô Storage (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                    const savedList = JSON.parse(localStorage.getItem('nameList')) || [];
                    const newData = result.data.map(sheetItem => {
                        const email = sheetItem.Email || sheetItem['E-Mail'] || '-';
                        const existingItem = savedList.find(s => s.email === email && email !== '-');
                        
                        return {
                            id: sheetItem.No || result.data.indexOf(sheetItem) + 1,
                            name: sheetItem.Name || '-',
                            company: sheetItem.Company || '-',
                            phone: sheetItem.Phone || sheetItem.Telephone || '-',
                            email: email,
                            checked: existingItem ? existingItem.checked : true, // ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ checked
                            sendStatus: existingItem ? existingItem.sendStatus : 'waiting',
                            deliveryStatus: existingItem ? existingItem.deliveryStatus : 'waiting'
                        };
                    });
                    
                    processNameListData(newData);
                    alert(`‚úÖ Load Data Success! Loaded ${newData.length} records from sheet: "${sheetName}"`);
                    isDirty = true;
                    
                } else {
                    alert(`‚ùå ERROR Loading Data: ${result.message}`);
                    document.getElementById('name-list-display').style.display = 'none';
                }

            } catch (error) {
                alert(`‚ùå ERROR: Cannot connect to Google Sheet API. Check URL, Sheet Name, CORS, and Apps Script deployment. Error: ${error.message}`);
                document.getElementById('name-list-display').style.display = 'none';
            } finally {
                loadButton.disabled = false;
                loadButton.innerHTML = `<i class="fas fa-sync-alt"></i> Load Data from Sheet`;
                document.getElementById('sheet-url').classList.remove('input-loading');
                document.getElementById('sheet-name').classList.remove('input-loading');
            }
        }
        
        function renderNameList() {
            const tbody = document.getElementById('name-list-tbody');
            const totalCountSpan = document.getElementById('total-count');
            const isEdit = isEditMode;
            
            tbody.innerHTML = '';
            
            if (nameListData.length === 0) {
                 document.getElementById('name-list-display').style.display = 'none';
                 return;
            }

            nameListData.forEach((item, index) => {
                const row = tbody.insertRow();
                // üí° ‡πÉ‡∏ä‡πâ index ‡πÄ‡∏õ‡πá‡∏ô fallback ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏µ‡πÄ‡∏°‡∏•
                const uniqueId = item.email && item.email !== '-' ? item.email : `temp-id-${index}`; 

                const cellCheckbox = row.insertCell();
                cellCheckbox.innerHTML = `<input type="checkbox" data-id="${uniqueId}" onchange="updateSelectedCount(); isDirty = true;" ${item.checked ? 'checked' : ''}>`;
                
                row.insertCell().textContent = item.id || (index + 1);
                
                const nameCell = row.insertCell();
                nameCell.innerHTML = `<span data-field="name" data-id="${uniqueId}" ${isEdit ? 'contenteditable="true"' : ''}>${item.name}</span>`;
                
                const companyCell = row.insertCell();
                companyCell.innerHTML = `<span data-field="company" data-id="${uniqueId}" ${isEdit ? 'contenteditable="true"' : ''}>${item.company}</span>`;
                
                const phoneCell = row.insertCell();
                phoneCell.innerHTML = `<span data-field="phone" data-id="${uniqueId}" ${isEdit ? 'contenteditable="true"' : ''}>${item.phone}</span>`;
                
                const emailCell = row.insertCell();
                emailCell.innerHTML = `<span data-field="email" data-id="${uniqueId}" ${isEdit ? 'contenteditable="true"' : ''}>${item.email}</span>`;
                
                const sendStatusCell = row.insertCell();
                let sendClass = item.sendStatus === 'sent' ? 'sent' : item.sendStatus === 'not-sent' ? 'not-sent' : 'waiting';
                sendStatusCell.innerHTML = `<span class="status-dot ${sendClass}"></span>`;
                
                const deliveryStatusCell = row.insertCell();
                let deliveryClass;
                let deliveryIcon;
                
                if (item.deliveryStatus === 'delivered') {
                    deliveryClass = 'delivered';
                    deliveryIcon = '<i class="fas fa-check-circle"></i>';
                } else if (item.deliveryStatus === 'pending') {
                    deliveryClass = 'pending';
                    deliveryIcon = '<i class="fas fa-times-circle"></i>'; 
                } else {
                    deliveryClass = 'waiting'; 
                    deliveryIcon = '<i class="far fa-circle"></i>'; 
                }
                deliveryStatusCell.innerHTML = `<span class="delivery-icon ${deliveryClass}">${deliveryIcon}</span>`;
            });
            
            document.getElementById('name-list-display').style.display = 'block'; 
            totalCountSpan.textContent = nameListData.length;
            updateSelectedCount(); 
            updateSelectAllCheckboxState();
        }
        
        function toggleSelectAll() {
            const masterCheckbox = document.getElementById('select-all-checkbox');
            document.querySelectorAll('#name-list-tbody input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = masterCheckbox.checked;
                // üí° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö temp-id ‡πÑ‡∏î‡πâ
                const id = checkbox.getAttribute('data-id');
                const item = nameListData.find(i => (i.email === id) || (i.email === '-' && id.startsWith('temp-id-') && parseInt(id.split('-').pop()) === nameListData.indexOf(i))); 
                if (item) {
                    item.checked = masterCheckbox.checked;
                }
            });
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const selectedCheckboxes = document.querySelectorAll('#name-list-tbody input[type="checkbox"]:checked');
            const selectedCountSpan = document.getElementById('selected-count');
            
            selectedCountSpan.textContent = selectedCheckboxes.length;
            
            // üí° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ checked ‡πÉ‡∏ô nameListData
            nameListData.forEach((item, index) => {
                const id = item.email && item.email !== '-' ? item.email : `temp-id-${index}`;
                const checkbox = document.querySelector(`#name-list-tbody input[data-id="${id}"]`);
                if (checkbox) {
                    item.checked = checkbox.checked;
                }
            });
            
            updateSelectAllCheckboxState();
        }
        
        function updateSelectAllCheckboxState() {
            const masterCheckbox = document.getElementById('select-all-checkbox');
            const selectedCheckboxes = document.querySelectorAll('#name-list-tbody input[type="checkbox"]:checked');
            const allCheckboxes = document.querySelectorAll('#name-list-tbody input[type="checkbox"]');
            
            if (allCheckboxes.length > 0) {
                if (selectedCheckboxes.length === allCheckboxes.length) {
                    masterCheckbox.checked = true;
                    masterCheckbox.indeterminate = false;
                } else if (selectedCheckboxes.length > 0) {
                    masterCheckbox.checked = false;
                    masterCheckbox.indeterminate = true;
                } else {
                    masterCheckbox.checked = false;
                    masterCheckbox.indeterminate = false;
                }
            } else {
                 masterCheckbox.checked = false;
                 masterCheckbox.indeterminate = false;
            }
        }
        
        function saveNameListToStorage() {
             localStorage.setItem('nameList', JSON.stringify(nameListData));
        }

        function loadNameListFromStorage() {
            const savedList = localStorage.getItem('nameList');
            if (savedList) {
                nameListData = JSON.parse(savedList);
                nameListData = nameListData.map(item => ({
                    ...item,
                    sendStatus: item.sendStatus || 'waiting', 
                    deliveryStatus: item.deliveryStatus || 'waiting'
                }));
                renderNameList();
            }
        }
        
        function toggleEditMode() {
            const buttonText = document.getElementById('edit-button-text');
            const nameListTable = document.getElementById('name-list-table');

            if (isEditMode) {
                saveNameListEdit();
                isEditMode = false;
                buttonText.innerHTML = 'Edit List';
                nameListTable.classList.remove('editing');
                alert('‚úÖ Name List Saved Successfully!');
            } else {
                isEditMode = true;
                buttonText.innerHTML = 'Save Changes';
                nameListTable.classList.add('editing');
            }
            renderNameList(); 
        }

        function saveNameListEdit() {
            const editableCells = document.querySelectorAll('#name-list-tbody span[contenteditable="true"]');
            let isChange = false;
            
            editableCells.forEach(span => {
                const uniqueId = span.getAttribute('data-id');
                const field = span.getAttribute('data-field');
                const newValue = span.textContent.trim() || '-'; 
                
                // üí° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö temp-id ‡πÑ‡∏î‡πâ
                const indexMatch = uniqueId.startsWith('temp-id-') ? parseInt(uniqueId.split('-').pop()) : -1;
                const item = nameListData.find((i, index) => i.email === uniqueId || (i.email === '-' && index === indexMatch));
                
                if (item && item[field] !== newValue) {
                    item[field] = newValue;
                    isChange = true;
                }
            });
            
            if (isChange) {
                isDirty = true;
                saveNameListToStorage();
            }
        }

        // ===== EXPORT TO REAL XLSX (SheetJS) =====
        function exportToXLSX() {
            if (nameListData.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Name List');
                return;
            }

            const rows = nameListData.map((item, index) => ({
                "No": item.id || index + 1,
                "Name": item.name,
                "Company": item.company,
                "Phone": item.phone,
                "Email": item.email,
                "EDM Sent": item.sendStatus,
                "Delivery Status": item.deliveryStatus
            }));

            const worksheet = XLSX.utils.json_to_sheet(rows);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "NameList");

            const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], {
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
            });

            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = `NameList_Export_${new Date().toISOString().slice(0, 10)}.xlsx`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert('‚úÖ Data exported successfully as XLSX!');
        }
        
        function clearNameListData() {
            if (nameListData.length === 0) {
                alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Name List ‡πÉ‡∏´‡πâ‡∏•‡∏ö");
                return;
            }
            
            const confirmation = confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Name List ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ");
            
            if (confirmation) {
                nameListData = [];
                localStorage.removeItem('nameList');
                
                const tbody = document.getElementById('name-list-tbody');
                tbody.innerHTML = '';
                document.getElementById('name-list-display').style.display = 'none';
                document.getElementById('total-count').textContent = '0';
                document.getElementById('selected-count').textContent = '0';
                document.getElementById('select-all-checkbox').checked = false;
                document.getElementById('select-all-checkbox').indeterminate = false;
                
                isDirty = true;
                alert('‚úÖ Name List Data ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
            }
        }
        
        // ================== CORE EMAIL SENDING FUNCTION (TO BACKEND) ==================

        // üí° ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Backend/Apps Script
        async function sendEmailToBackend(payload, type = 'Single') {
            
            // 1. ‡∏î‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Gmail SMTP
            const smtpConfig = JSON.parse(localStorage.getItem('smtpConfig'));

            if (!smtpConfig || !smtpConfig.email || !smtpConfig.appPassword || smtpConfig.appPassword.length !== 16) {
                alert('‚ùå ERROR: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Gmail Sender Email ‡πÅ‡∏•‡∏∞ App Password (16 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£) ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Admin Panel ‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•.');
                console.error('SMTP configuration is missing or invalid.');
                return { success: false, message: 'SMTP configuration missing or invalid.' };
            }

            // 2. ‡∏ú‡∏ô‡∏ß‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SMTP ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô Payload
            const finalPayload = {
                 ...payload,
                 smtp: {
                     senderEmail: smtpConfig.email,
                     appPassword: smtpConfig.appPassword
                 }
            };

            // 3. ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á Backend
            console.log(`Sending ${type} Email request to Backend API...`, finalPayload);
            
            try {
                // ‚ö†Ô∏è NOTE: ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Backend Server (‡πÄ‡∏ä‡πà‡∏ô GAS/Node.js) ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ CORS ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß
                const response = await fetch(BACKEND_API_URL, {
                    method: 'POST',
                    mode: 'cors', 
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(finalPayload)
                });
                
                if (!response.ok) {
                    // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å Backend
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}. Response: ${errorText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    console.log(`‚úÖ ${type} Email Sent Success (via Backend):`, result.message);
                } else {
                    console.error(`‚ùå ${type} Email Failed (via Backend):`, result.message);
                }
                
                return result;

            } catch (error) {
                alert(`‚ùå ERROR: ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Backend/Apps Script ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß! (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Network, CORS, ‡πÅ‡∏•‡∏∞ URL) - ${error.message}`);
                console.error('Backend Connection/Fetch Error:', error);
                return { success: false, message: 'Connection Error to Backend.' };
            }
        }

        // ================== EDM INVITATION SENDING (NAME LIST) ==================

        async function sendNameListEmail() {
             if (isEditMode) {
                 saveNameListEdit();
             }
            
            const selectedRecipients = nameListData.filter(item => item.checked && item.email && item.email !== '-');
            
            if (selectedRecipients.length === 0) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á EDM.");
                return;
            }
            
            const confirmSend = confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á EDM Invitation ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö ${selectedRecipients.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏à‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ô Gmail ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì`);
            
            if (!confirmSend) return;

            // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ EDM
            const eventTitle = document.getElementById('event-title').value;
            const emailSubject = document.getElementById('email-subject').value;
            const edmContent = tinymce.get('edm-content').getContent();
            
            if (!eventTitle || !emailSubject || !edmContent) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Event Title, Email Subject, ‡πÅ‡∏•‡∏∞ EDM Content ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }

            const payload = {
                action: 'sendBulkEDM', 
                recipients: selectedRecipients.map(item => ({ 
                    name: item.name, 
                    email: item.email, 
                    ref_id: item.id
                })),
                subject: emailSubject,
                htmlBody: edmContent,
                eventTitle: eventTitle
            };
            
            alert(`üì¢ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á EDM Invitation ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö ${selectedRecipients.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ú‡πà‡∏≤‡∏ô Backend/SMTP)`);

            // 2. ‡∏™‡πà‡∏á Payload ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Backend
            const result = await sendEmailToBackend(payload, 'Bulk EDM');
            
            if (result.success) {
                // 3. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô Name List (‡∏à‡∏≥‡∏•‡∏≠‡∏á)
                selectedRecipients.forEach(item => {
                    item.sendStatus = 'sent';
                    item.deliveryStatus = 'waiting';
                });
                renderNameList();
                saveNameListToStorage();

                alert(`‚úÖ ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á EDM ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Backend ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì`);
                
                // 4. ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Delivery Status 
                setTimeout(() => {
                    selectedRecipients.forEach(item => {
                        if (item.deliveryStatus === 'waiting') {
                            if (Math.random() > 0.1) {
                                item.deliveryStatus = 'delivered';
                            } else {
                                item.deliveryStatus = 'pending';
                            }
                        }
                    });
                    renderNameList();
                    saveNameListToStorage();
                    console.log("üì¢ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö EDM (Delivery Status) ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß (‡∏à‡∏≥‡∏•‡∏≠‡∏á)");
                }, 5000); 

            } else {
                alert(`‚ùå ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á EDM ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${result.message}`);
            }
        }
        
        // ================== CONFIRM EMAIL SENDING (AUTO) ==================
        
        async function sendConfirmationEmail(data) {
            
            if (!getConfirmationToggles().autoSend) {
                console.log("‚ùå Auto Send is DISABLED. Confirmation Email skipped.");
                return;
            }
            
            if (!data || !data.recipient || !data.refId) {
                console.error("Missing recipient or refId for confirmation email.");
                return;
            }
            
            // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå‡πÅ‡∏•‡∏∞ Toggles
            const eventTitle = document.getElementById('event-title').value;
            const confirmSubject = document.getElementById('confirm-subject').value;
            const eventVenue = document.getElementById('event-venue').value; 
            const toggles = getConfirmationToggles(); 
            
            if (!eventTitle || !confirmSubject) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Event Title ‡πÅ‡∏•‡∏∞ Confirmation Subject ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }
            
            const payload = {
                action: 'sendConfirmation', 
                recipient: data.recipient,
                subject: confirmSubject.replace('[Event Title]', eventTitle),
                refId: data.refId,
                eventTitle: eventTitle,
                venue: eventVenue,
                toggles: toggles
                // Backend ‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á HTML Body ‡∏à‡∏≤‡∏Å Toggles
            };
            
            console.log(`Sending Confirmation Email request for ${data.recipient} (via Backend/SMTP)`);

            // 2. ‡∏™‡πà‡∏á Payload ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Backend
            const result = await sendEmailToBackend(payload, 'Confirmation');
            
            if (result.success) {
                console.log(`‚úÖ Confirmation Email sent successfully (via Backend)`);
            } else {
                console.error(`‚ùå Confirmation Email failed (via Backend): ${result.message}`);
            }
        }
        
        // üí° ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á Backend ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Confirmation Email
        function toggleEmailSending() {
            const isEnabled = document.getElementById('toggle-auto-send').checked;
            const statusDiv = document.getElementById('email-polling-status');
            
            statusDiv.classList.remove('status-on', 'status-off');

            if (isEnabled) {
                 statusDiv.classList.add('status-on');
                 statusDiv.innerHTML = `Auto-Send: **ACTIVE**. **(Backend Required)**. Apps Script or Node.js must be running to handle this.`;
            } else {
                statusDiv.classList.add('status-off');
                statusDiv.innerHTML = `Auto-Send: **DISABLED**. Backend logic will ignore new registration events.`;
            }
        }
        
    </script>
</body>
</html>